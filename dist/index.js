!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports["ticalc-usb"]=t():e["ticalc-usb"]=t()}(this,(function(){return e={509:(e,t,s)=>{function n(e,t){const s=e.data&&e.data.length||0,n=r(s,4);n.splice(4,0,...r(e.type,t));const i=new Uint8Array(n.length+s);return i.set(n),i.set(e.data||[],n.length),i}function r(e,t){if(e>Number.MAX_SAFE_INTEGER)throw"Number too big to reliably convert";const s=[];for(;t>0;)t--,s.push(e/Math.pow(256,t)&255);return s}function i(e){if(!function(e){let t=!1;return(e=e.filter((e=>!(0==e&&!t||(t=!0,0))))).length<7||7==e.length&&e[0]<=31}(e))throw"Number too big to reliably convert";let t=e.length,s=0,n=0;for(;t>0;)t--,s+=(255&e[n++])*Math.pow(256,t);return s}e.exports={constructRawPacket:function(e){return n(e,1)},destructRawPacket:function(e){return{size:i(e.slice(0,4)),type:e[4],data:e.slice(5)}},constructVirtualPacket:function(e){return n(e,2)},destructVirtualPacket:function(e){return{size:i(e.slice(0,4)),type:i(e.slice(4,6)),data:e.slice(6)}},constructParameters:function(e){return new Uint8Array([r(e.length,2),...e.map((e=>[r(e.type,2),r(e.size,2),r(e.value,e.size)].flat()))].flat())},destructParameters:function(e){const t=[],s=i(e.slice(0,2));let n=2;for(let r=0;r<s;r++){const s=i(e.slice(n+3,n+5));t.push({type:i(e.slice(n,n+2)),ok:0==e[n+2],size:s,value:i(e.slice(n+5,n+5+s))}),n+=5+s}return t},intToBytes:r,bytesToInt:i,asciiToBytes:function(e,t){t=t||e.length+1;const n=new("undefined"!=typeof TextEncoder?TextEncoder:s(790).TextEncoder)("utf-8").encode(e),r=new Uint8Array(t);return r.set(n.slice(0,t)),r},bytesToAscii:function(e){const t=e.indexOf(0);return t>=0&&(e=e.slice(0,t)),new("undefined"!=typeof TextDecoder?TextDecoder:s(790).TextDecoder)("utf-8").decode(e)},chunkArray:function(e,t){const s=[];let n,r=0;for(n=0;n<t.length;n++)if(s.push(e.slice(r,r+t[n])),r+=t[n],r>=e.length)return s;for(n--;r<e.length;)s.push(e.slice(r,r+t[n])),r+=t[n];return s}}},24:e=>{e.exports={identifier:{vendorId:1105}}},770:(e,t,s)=>{const n={name:"TI-83 Premium CE",status:"beta",identifier:{vendorId:1105,productId:57352},matcher:{vendorId:1105,productId:57352,productName:"TI-83 Premium CE"},compatibleFiles:["TI-83","TI-84 Plus","TI-84 Plus Color"]},r=s(256);e.exports={...n,connect:e=>new r({device:e,properties:n}).connect()}},484:(e,t,s)=>{const n={name:"TI-84 Plus CE",status:"beta",identifier:{vendorId:1105,productId:57352},matcher:{vendorId:1105,productId:57352,productName:"TI-84 Plus CE"},compatibleFiles:["TI-83","TI-84 Plus","TI-84 Plus Color"]},r=s(256);e.exports={...n,connect:e=>new r({device:e,properties:n}).connect()}},699:(e,t,s)=>{const n={name:"TI-82 Advanced",status:"experimental",identifier:{vendorId:1105,productId:57352},matcher:{vendorId:1105,productId:57352,productName:"TI-82 Advanced"},compatibleFiles:["TI-83","TI-84 Plus"]},r=s(875);e.exports={...n,connect:e=>new r({device:e,properties:n}).connect()}},662:(e,t,s)=>{const n={name:"TI-84 Plus",status:"supported",identifier:{vendorId:1105,productId:57347},matcher:{vendorId:1105,productId:57347},compatibleFiles:["TI-83","TI-84 Plus"]},r=s(875);e.exports={...n,connect:e=>new r({device:e,properties:n}).connect()}},340:(e,t,s)=>{const n={name:"TI-84 Plus C Silver Edition",status:"experimental",identifier:{vendorId:1105,productId:57352},matcher:{vendorId:1105,productId:57352,productName:"TI-84 Plus C Silver Edition"},compatibleFiles:["TI-83","TI-84 Plus","TI-84 Plus Color"]},r=s(875);e.exports={...n,connect:e=>new r({device:e,properties:n}).connect()}},986:(e,t,s)=>{const n={name:"TI-84 Plus SE",status:"beta",identifier:{vendorId:1105,productId:57352},matcher:{vendorId:1105,productId:57352,productName:"TI-84 Plus Silver Edition"},compatibleFiles:["TI-83","TI-84 Plus"]},r=s(875);e.exports={...n,connect:e=>new r({device:e,properties:n}).connect()}},659:(e,t,s)=>{const n={name:"TI-84 Plus T",status:"experimental",identifier:{vendorId:1105,productId:57352},matcher:{vendorId:1105,productId:57352,productName:"TI-84 Plus T"},compatibleFiles:["TI-83","TI-84 Plus"]},r=s(875);e.exports={...n,connect:e=>new r({device:e,properties:n}).connect()}},725:(e,t,s)=>{const n=s(225),r=s(509);e.exports=class{constructor(e){this._device=e}async connect(){await this._device.open(),await this._device.selectConfiguration(this._device.configuration.configurationValue);const e=this._device.configuration.interfaces[0];await this._device.claimInterface(e.interfaceNumber),this._inEndpoint=e.alternates[0].endpoints.find((e=>"in"==e.direction)),this._outEndpoint=e.alternates[0].endpoints.find((e=>"out"==e.direction)),this._bufferSize=await this._requestBufferSize()}async send(e){const t=r.constructVirtualPacket(e),s=r.chunkArray(t||[],[this._bufferSize-n.rawPacketTypes.HEADER_SIZE]);for(let e=0;e<s.length;e++){const t=e==s.length-1?n.rawPacketTypes.DUSB_RPKT_VIRT_DATA_LAST:n.rawPacketTypes.DUSB_RPKT_VIRT_DATA,i=s[e];await this._send(r.constructRawPacket({type:t,data:i})),await this._expectAck()}}async expect(e){const t=r.destructRawPacket(await this._receive());if(t.type!=n.rawPacketTypes.DUSB_RPKT_VIRT_DATA_LAST)throw`Expected raw packet type VIRT_DATA_LAST, but got ${t.type} instead`;const s=r.destructVirtualPacket(t.data);switch(s.type){case e:return await this._sendAck(),s;case n.virtualPacketTypes.DUSB_VPKT_DELAY_ACK:await this._sendAck();const t=r.bytesToInt(s.data);return await this.wait(t/1e3),this.expect(e);default:throw`Expected virtual packet type ${e}, but got ${s.type} instead`}}wait(e){return new Promise(((t,s)=>{setTimeout((()=>t()),e)}))}async _requestBufferSize(){await this._send(r.constructRawPacket({type:n.rawPacketTypes.DUSB_RPKT_BUF_SIZE_REQ,data:[0,0,4,0]}));const e=r.destructRawPacket(await this._receive());if(e.type!=n.rawPacketTypes.DUSB_RPKT_BUF_SIZE_ALLOC)throw`Expected BUF_SIZE_ALLOC, got ${e.type} instead`;return r.bytesToInt(e.data)}_send(e){return this._device.transferOut(this._outEndpoint.endpointNumber,e)}async _receive(){const e=await this._device.transferIn(this._inEndpoint.endpointNumber,this._inEndpoint.packetSize);if("ok"!=e.status)throw`Error in receiving data from device: ${e.status}`;return new Uint8Array(e.data.buffer)}_sendAck(){return this._send(r.constructRawPacket({type:n.rawPacketTypes.DUSB_RPKT_VIRT_DATA_ACK,data:[224,0]}))}async _expectAck(){const e=r.destructRawPacket(await this._receive());if(e.type!=n.rawPacketTypes.DUSB_RPKT_VIRT_DATA_ACK)throw`Expected ACK, got ${e.type} instead`}}},256:(e,t,s)=>{const n=s(875);e.exports=class extends n{async getFreeMem(){const e=await super.getFreeMem();return 0==e.ram&&(e.ram=void 0),e}}},225:e=>{e.exports={rawPacketTypes:{DUSB_RPKT_BUF_SIZE_REQ:1,DUSB_RPKT_BUF_SIZE_ALLOC:2,DUSB_RPKT_VIRT_DATA:3,DUSB_RPKT_VIRT_DATA_LAST:4,DUSB_RPKT_VIRT_DATA_ACK:5,HEADER_SIZE:5},virtualPacketTypes:{DUSB_VPKT_PING:1,DUSB_VPKT_OS_BEGIN:2,DUSB_VPKT_OS_ACK:3,DUSB_VPKT_OS_HEADER:4,DUSB_VPKT_OS_DATA:5,DUSB_VPKT_EOT_ACK:6,DUSB_VPKT_PARM_REQ:7,DUSB_VPKT_PARM_DATA:8,DUSB_VPKT_DIR_REQ:9,DUSB_VPKT_VAR_HDR:10,DUSB_VPKT_RTS:11,DUSB_VPKT_VAR_REQ:12,DUSB_VPKT_VAR_CNTS:13,DUSB_VPKT_PARM_SET:14,DUSB_VPKT_MODIF_VAR:16,DUSB_VPKT_EXECUTE:17,DUSB_VPKT_MODE_SET:18,DUSB_VPKT_DATA_ACK:43520,DUSB_VPKT_DELAY_ACK:47872,DUSB_VPKT_EOT:56576,DUSB_VPKT_ERROR:60928,HEADER_SIZE:6},modes:{DUSB_MODE_STARTUP:[0,1,0,1,0,0,0,0,7,208],DUSB_MODE_BASIC:[0,2,0,1,0,0,0,0,7,208],DUSB_MODE_NORMAL:[0,3,0,1,0,0,0,0,7,208]},executeCommands:{DUSB_EID_PRGM:0,DUSB_EID_ASM:1,DUSB_EID_APP:2,DUSB_EID_KEY:3,DUSB_EID_UNKNOWN:4},parameters:{DUSB_PID_PRODUCT_NUMBER:1,DUSB_PID_PRODUCT_NAME:2,DUSB_PID_MAIN_PART_ID:3,DUSB_PID_HW_VERSION:4,DUSB_PID_FREE_RAM:14,DUSB_PID_FREE_FLASH:17,DUSB_PID_COLOR_AVAILABLE:27,DUSB_PID_BITS_PER_PIXEL:29,DUSB_PID_LCD_WIDTH:30,DUSB_PID_LCD_HEIGHT:31,DUSB_PID_MATH_CAPABILITIES:75,DUSB_PID_PYTHON_ON_BOARD:93},attributes:{DUSB_AID_VAR_TYPE:2,DUSB_AID_ARCHIVED:3,DUSB_AID_VAR_VERSION:8},transferModes:{SILENT:1,NON_SILENT:2}}},875:(e,t,s)=>{const n=s(725),r=s(225),i=s(509);e.exports=class{constructor({device:e,properties:t}){this._d=new n(e),Object.assign(this,t)}async connect(){return await this._d.connect(),this}canReceive(e){return this.compatibleFiles.includes(e.calcType)}async getStorageDetails(e){const t=await this.getFreeMem(),s={ram:e.entries.filter((e=>!e.attributes.archived)).reduce(((e,t)=>e+t.size),0),flash:e.entries.filter((e=>e.attributes.archived)).reduce(((e,t)=>e+t.size),0)};return{free:t,required:s,fits:t.flash>=s.flash&&(void 0===t.ram||t.ram>=s.ram)}}async isReady(){try{return await this._d.send({type:r.virtualPacketTypes.DUSB_VPKT_PING,data:r.modes.DUSB_MODE_NORMAL}),await this._d.expect(r.virtualPacketTypes.DUSB_VPKT_MODE_SET),!0}catch(e){return console.debug(e),!1}}async pressKey(e){await this._d.send({type:r.virtualPacketTypes.DUSB_VPKT_EXECUTE,data:[0,0,r.executeCommands.DUSB_EID_KEY,0,e]}),await this._d.expect(r.virtualPacketTypes.DUSB_VPKT_DATA_ACK)}async getFreeMem(){await this._d.send({type:r.virtualPacketTypes.DUSB_VPKT_PARM_REQ,data:[0,2,i.intToBytes(r.parameters.DUSB_PID_FREE_RAM,2),i.intToBytes(r.parameters.DUSB_PID_FREE_FLASH,2)].flat()});const e=await this._d.expect(r.virtualPacketTypes.DUSB_VPKT_PARM_DATA),t=i.destructParameters(e.data);if(!t.every((e=>e.ok)))throw"Could not succesfully get all parameters";return{ram:t.find((e=>e.type==r.parameters.DUSB_PID_FREE_RAM)).value,flash:t.find((e=>e.type==r.parameters.DUSB_PID_FREE_FLASH)).value}}async sendFile(e){for(let t=0;t<e.entries.length;t++)await this._sendEntry(e.entries[t])}async _sendEntry(e){await this._d.send({type:r.virtualPacketTypes.DUSB_VPKT_RTS,data:[...i.intToBytes(e.name.length,2),...i.asciiToBytes(e.name,e.name.length),0,...i.intToBytes(e.size,4),r.transferModes.SILENT,...this._entryParameters(e)]}),await this._d.expect(r.virtualPacketTypes.DUSB_VPKT_DATA_ACK),await this._d.send({type:r.virtualPacketTypes.DUSB_VPKT_VAR_CNTS,data:e.data}),await this._d.expect(r.virtualPacketTypes.DUSB_VPKT_DATA_ACK),await this._d.send({type:r.virtualPacketTypes.DUSB_VPKT_EOT})}_entryParameters(e){return i.constructParameters([{type:r.attributes.DUSB_AID_VAR_TYPE,size:4,value:4026990592+e.type},{type:r.attributes.DUSB_AID_ARCHIVED,size:1,value:e.attributes&&e.attributes.archived?1:0},{type:r.attributes.DUSB_AID_VAR_VERSION,size:4,value:e.attributes&&e.attributes.version||0}])}}},138:(e,t,s)=>{e.exports={ticalc:s(315),tifiles:s(823)}},315:(e,t,s)=>{const n=s(549),r=[s(699),s(662),s(340),s(986),s(659),s(770),s(484)],i=["none","experimental","beta","partial-support","supported"];let c,a=_();const o={},u={connect:[],disconnect:[]};function _(e){if(e||(e="supported"),!i.includes(e))throw"Invalid support level selected, should be one of: "+i.join(", ");if("none"==e)return r.concat(s(24));const t=i.slice(i.indexOf(e));return r.filter((e=>t.includes(e.status)))}function d(){return!!navigator.usb}async function l(e){const t=a.filter((e=>e.matcher)).find((t=>Object.keys(t.matcher).every((s=>t.matcher[s]==e[s]))));if(!t)throw{message:"Calculator model not supported",device:e};const s=await t.connect(e);return o[e.toString()]=s,s}async function p(e){return o[e]||await l(e)}function T(){if(!d())throw"Browser not supported";return c||(c=n(navigator.usb,{injections:{transferIn:(e,t)=>console.debug("🖥←📱 Received:",I(new Uint8Array(t.data.buffer))),transferOut:(e,t)=>console.debug("🖥→📱 Sent:    ",I(e[1]))}}),c)}function I(e){const t=[...e].map((e=>e.toString(16).toUpperCase().padStart(2,"0")));return[t.slice(0,4).join(""),t.slice(4,5).join(""),t.length>10?[t.slice(5,9).join(""),t.slice(9,11).join(""),t.slice(11).join(",")]:t.slice(5).join(",")].flat().join(" ")}e.exports={browserSupported:d,models:()=>r.map((e=>({name:e.name,status:e.status,matcher:e.matcher}))),addEventListener:(e,t)=>{if(!Object.keys(u).includes(e))throw`Invalid event name: ${e}`;u[e].push(t)},init:async(e={})=>{e.usb||T(),a=_(e.supportLevel),navigator.usb.addEventListener("connect",(async e=>{const t=await p(device);console.debug("📱 Calculator connected"),t&&u.connect.forEach((e=>e(t)))})),navigator.usb.addEventListener("disconnect",(e=>{const t=o[e.device];console.debug("📱 Calculator disconnected"),t&&u.disconnect.forEach((e=>e(t)))}));const t=await navigator.usb.getDevices();for(let e=0;e<t.length;e++){const s=await p(t[e]);u.connect.forEach((e=>e(s)))}},choose:async(e={})=>{const t=e.usb||T();let s;try{s=await t.requestDevice({filters:a.map((e=>e.identifier)).filter(((e,t,s)=>t===s.findIndex((t=>t.vendorId===e.vendorId&&t.productId===e.productId)))).sort(((e,t)=>e.vendorId>t.vendorId?1:e.vendorId<t.vendorId?-1:e.productId<t.productId?1:-1))})}catch(e){throw e}const n=await l(s);u.connect.forEach((e=>e(n)))},getRecording:()=>c}},823:(e,t,s)=>{const n=s(509);function r(e,t){const s=[];let n=0;for(;n<t.size;){const r=i(e.slice(n),t);s.push(r),n+=r.entrySize}return s}function i(e,t){const s=function(e,t){const s=n.bytesToInt(e.slice(0,2).reverse()),r=13==s,i=s>=12;if("TI-85"==t.calcType){const t=e[5];return{size:6+t+2,name:e.slice(6,6+t),attributes:!1}}if("TI-86"==t.calcType)return{size:6+(i?8:e[5])+2,name:e.slice(6,6+e[5]),attributes:!1};if(r){const t=n.bytesToInt(e.slice(13,15).reverse());return{size:17,name:e.slice(5,13),attributes:128==t?{archived:!0,version:0}:{archived:!!(32768&t),version:255&t}}}return{size:15,name:e.slice(5,13),attributes:!1}}(e,t),r=n.bytesToInt(e.slice(2,4).reverse());return{name:n.bytesToAscii(s.name),type:e[4],attributes:s.attributes,size:r,data:e.slice(s.size,s.size+r),entrySize:s.size+r,debug:{packetLength:n.bytesToInt(e.slice(0,2).reverse()),ti83p:13==n.bytesToInt(e.slice(0,2).reverse()),padded86:n.bytesToInt(e.slice(0,2).reverse())>12,nameLength:e[5],headerSize:s.size,size2:n.bytesToInt(e.slice(s.size-2,s.size).reverse())}}}function c(e){return 26==e[0]&&12==e[1]&&0==e[2]?"TI-85 style signature present":26==e[0]&&10==e[1]&&0==e[2]?"TI-73/82/83/86 style signature present":"NONE"}e.exports={parseFile:e=>{const t=(s=e.slice(0,8),{"**TI73**":"TI-73","**TI82**":"TI-82","**TI83**":"TI-83","**TI83F*":"TI-84 Plus","**TI85**":"TI-85","**TI86**":"TI-86","**TI89**":"TI-89","**TI92**":"TI-92","**TI92P*":"TI-92 Plus","**V200**":"TI-V200","**TICBL*":"TI-CBL2"}[n.bytesToAscii(s)]||"NONE");var s;const i=n.bytesToInt(e.slice(53,55).reverse());return{calcType:t,size:i,comments:n.bytesToAscii(e.slice(11,53)),entries:r(e.slice(55),{size:i,calcType:t}),debug:{signature:c(e.slice(8,11)),sizeCorrect:e.length==i+8+3+42+2+2,checksum:e.slice(e.length-2,e.length)}}},isValid:e=>"NONE"!=e.calcType&&e.size>0&&e.debug.sizeCorrect&&e.entries.length>0}},549:e=>{e.exports=(e,s)=>new t(e,s);class t{constructor(e,t={}){this._usb=e,this._options=t,this._steps=[]}async requestDevice(...e){const t=await this._usb.requestDevice(...e),s=this._proxy(t);return this._logStep({action:"asyncFunctionCall",name:"requestDevice",parameters:e,resolve:t}),s}async getDevices(...e){const t=await this._usb.getDevices(...e),s=t.map((e=>this._proxy(e)));return this._logStep({action:"asyncFunctionCall",name:"getDevices",parameters:e,resolve:t}),s}getSteps(){return this._steps}_proxy(e){return new Proxy(e,{get:(e,t)=>{if("function"!=typeof e[t]){const s=Reflect.get(e,t);return this._logPropertyAccess(s,t)}return(...s)=>{const n=e[t](...s);return n instanceof Promise?this._logPromise(n,t,s):this._logFunctionCall(n,t,s)}}})}_logPromise(e,t,n){return e.then((e=>(this._logStep({action:"asyncFunctionCall",name:t.toString(),parameters:s(n),resolve:s(e)}),this._inject(e,t,n),e))).catch((e=>{throw this._logStep({action:"asyncFunctionCall",name:t.toString(),parameters:s(n),reject:s(e)}),this._inject(e,t,n),e}))}_logFunctionCall(e,t,n){return this._logStep({action:"functionCall",name:t.toString(),parameters:s(n),result:s(e)}),this._inject(e,t,n),e}_logPropertyAccess(e,t){return this._logStep({action:"propertyAccess",name:t.toString(),result:s(e)}),e}_logStep(e){this._steps.push(e),this._options.verbose&&console.debug(e)}_inject(e,t,s){this._options.injections&&this._options.injections[t]&&this._options.injections[t](s,e)}}function s(e){return e?e instanceof DataView?{byteLength:(t=e).byteLength,byteOffset:t.byteOffset,buffer:Array.from(new Uint8Array(t.buffer))}:Array.isArray(e)?e.map((e=>s(e))):"object"==typeof e?(n=e,Object.keys(n).reduce(((e,t)=>(e[t]=s(n[t]),e)),{})):JSON.parse(JSON.stringify(e)):e;var t,n}},790:()=>{}},t={},function s(n){var r=t[n];if(void 0!==r)return r.exports;var i=t[n]={exports:{}};return e[n](i,i.exports,s),i.exports}(138);var e,t}));